<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Editor - Adventskalender 2024</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            font-family: 'Arial', sans-serif;
        }

        .editor-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Sticky Avatar Preview Header */
        .avatar-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .avatar-header.scrolled {
            padding: 10px 20px;
        }

        .avatar-header.scrolled .avatar-preview {
            width: 80px;
            height: 80px;
        }

        .avatar-header.scrolled h1 {
            font-size: 1.2rem;
            margin-bottom: 0;
        }

        .avatar-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .avatar-info {
            flex: 1;
        }

        .avatar-header h1 {
            font-size: 2rem;
            margin: 0 0 10px 0;
            color: #333;
            transition: all 0.3s ease;
        }

        .score-display {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            background: white;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Style Selector */
        .style-selector {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .style-selector h2 {
            margin: 0 0 20px 0;
            color: #333;
        }

        .style-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .style-card {
            background: #f8f9fa;
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .style-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .style-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .style-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .lock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* Customization Options */
        .customization-panel {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .option-group {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e0e0e0;
        }

        .option-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .option-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .option-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.2rem;
        }

        .unlock-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }

        .option-item {
            aspect-ratio: 1;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
            color: #666;
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
        }

        .option-item:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .option-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            color: #667eea;
        }

        .option-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .option-item.locked::after {
            content: 'üîí';
            position: absolute;
            font-size: 1.5rem;
        }

        /* Color Options */
        .option-item.color-option {
            border-radius: 50%;
        }

        /* Next Unlocks */
        .next-unlocks {
            background: linear-gradient(135deg, #fff7e6 0%, #ffe6f0 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 25px;
        }

        .next-unlocks h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .unlock-item {
            background: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .unlock-item:last-child {
            margin-bottom: 0;
        }

        .unlock-item-name {
            font-weight: bold;
            color: #667eea;
        }

        .unlock-item-points {
            color: #ff6b6b;
            font-weight: bold;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .avatar-header-content {
                flex-direction: column;
                text-align: center;
            }

            .style-grid {
                grid-template-columns: 1fr;
            }

            .options-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Sticky Avatar Header -->
    <div class="avatar-header" id="avatarHeader">
        <div class="avatar-header-content">
            <div class="avatar-preview" id="avatarPreviewHeader">
                <img id="avatarPreviewImage" src="" alt="Avatar Preview">
            </div>
            <div class="avatar-info">
                <h1>‚ú® Erstelle deinen Avatar</h1>
                <div class="score-display">
                    ‚≠ê <span id="userScore">0</span> Punkte
                </div>
                <div class="avatar-actions">
                    <button class="btn btn-secondary" onclick="randomizeAvatar()">üé≤ Zuf√§llig</button>
                    <button class="btn btn-primary" onclick="saveAvatar()">üíæ Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <div class="editor-container">
        <!-- Style Selector -->
        <div class="style-selector">
            <h2>üé® W√§hle deinen Avatar-Stil</h2>
            <div class="style-grid" id="styleGrid">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>

        <!-- Customization Panel -->
        <div class="customization-panel">
            <h2>‚öôÔ∏è Anpassungen</h2>
            <div id="customizationOptions">
                <div class="loading">Lade Optionen...</div>
            </div>

            <!-- Next Unlocks -->
            <div class="next-unlocks" id="nextUnlocks" style="display: none;">
                <h3>üéÅ N√§chste Freischaltungen</h3>
                <div id="nextUnlocksList"></div>
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen
        let styleSchemas = {};
        let currentStyle = 'adventurer';
        let currentOptions = {};
        let userScore = 150; // Demo-Wert, sp√§ter aus Stats laden

        // Initialisierung
        async function init() {
            // Scroll-Handler f√ºr Sticky Header
            window.addEventListener('scroll', () => {
                const header = document.getElementById('avatarHeader');
                if (window.scrollY > 50) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });

            // Lade Style-Schemas
            await loadStyleSchemas();
            
            // Setze initialen Score
            document.getElementById('userScore').textContent = userScore;
            
            // Rendere Style-Auswahl
            renderStyleSelector();
            
            // Lade ersten Style
            selectStyle('adventurer');
        }

        // Lade Style-Schemas aus JSON
        async function loadStyleSchemas() {
            try {
                const response = await fetch('avatarStyleSchemas.json');
                styleSchemas = await response.json();
                console.log('Style-Schemas geladen:', styleSchemas);
            } catch (error) {
                console.error('Fehler beim Laden der Style-Schemas:', error);
                alert('Fehler beim Laden der Avatar-Konfiguration');
            }
        }

        // Rendere Style-Auswahl
        function renderStyleSelector() {
            const grid = document.getElementById('styleGrid');
            grid.innerHTML = '';

            Object.keys(styleSchemas).forEach(styleId => {
                const style = styleSchemas[styleId];
                const isLocked = userScore < style.unlockScore;

                const card = document.createElement('div');
                card.className = `style-card ${styleId === currentStyle ? 'active' : ''} ${isLocked ? 'locked' : ''}`;
                
                if (isLocked) {
                    card.innerHTML = `
                        <div class="lock-badge">üîí ${style.unlockScore}‚òÖ</div>
                        <h3>${style.displayName}</h3>
                        <p>Ben√∂tigt ${style.unlockScore} Punkte</p>
                    `;
                } else {
                    card.innerHTML = `
                        <h3>${style.displayName}</h3>
                        <p>Verf√ºgbar ‚úì</p>
                    `;
                    card.onclick = () => selectStyle(styleId);
                }

                grid.appendChild(card);
            });
        }

        // W√§hle einen Style
        function selectStyle(styleId) {
            const style = styleSchemas[styleId];
            if (!style || userScore < style.unlockScore) {
                return;
            }

            currentStyle = styleId;
            currentOptions = {
                seed: `User-${Date.now()}`
            };

            // Setze Default-Werte f√ºr alle verf√ºgbaren Optionen
            Object.keys(style.options).forEach(optionKey => {
                const option = style.options[optionKey];
                if (userScore >= option.unlockScore && option.values.length > 0) {
                    currentOptions[optionKey] = option.values[0];
                }
            });

            renderStyleSelector();
            renderCustomizationOptions();
            updatePreview();
        }

        // Rendere Anpassungsoptionen
        function renderCustomizationOptions() {
            const container = document.getElementById('customizationOptions');
            const style = styleSchemas[currentStyle];
            
            if (!style) {
                container.innerHTML = '<p>Kein Style ausgew√§hlt</p>';
                return;
            }

            container.innerHTML = '';

            // Gruppiere Optionen nach Unlock-Score
            const basicOptions = [];
            const advancedOptions = [];

            Object.keys(style.options).forEach(optionKey => {
                const option = style.options[optionKey];
                if (option.unlockScore === 0 || option.unlockScore === 50) {
                    basicOptions.push([optionKey, option]);
                } else {
                    advancedOptions.push([optionKey, option]);
                }
            });

            // Rendere Basic Options
            basicOptions.forEach(([key, option]) => {
                renderOptionGroup(key, option, container);
            });

            // Rendere Advanced Options
            advancedOptions.forEach(([key, option]) => {
                renderOptionGroup(key, option, container);
            });

            // Zeige Next Unlocks
            updateNextUnlocks();
        }

        // Rendere eine Option-Gruppe
        function renderOptionGroup(key, option, container) {
            const isLocked = userScore < option.unlockScore;
            
            const group = document.createElement('div');
            group.className = 'option-group';
            
            const header = document.createElement('div');
            header.className = 'option-header';
            header.innerHTML = `
                <h3>${option.displayName}</h3>
                ${isLocked ? `<span class="unlock-badge">üîí ${option.unlockScore}‚òÖ</span>` : ''}
            `;
            group.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'options-grid';

            option.values.forEach(value => {
                const item = document.createElement('div');
                item.className = `option-item ${option.type === 'color' ? 'color-option' : ''} ${currentOptions[key] === value ? 'active' : ''} ${isLocked ? 'locked' : ''}`;
                
                if (option.type === 'color') {
                    item.style.background = `#${value}`;
                    item.title = `#${value}`;
                } else {
                    // Zeige die Varianten-Nummer
                    const displayText = value.replace('variant', '').replace(/^0+/, '');
                    item.textContent = displayText || value;
                    item.title = value;
                }

                if (!isLocked) {
                    item.onclick = () => selectOption(key, value);
                }

                grid.appendChild(item);
            });

            group.appendChild(grid);
            container.appendChild(group);
        }

        // W√§hle eine Option
        function selectOption(key, value) {
            currentOptions[key] = value;
            renderCustomizationOptions();
            updatePreview();
        }

        // Update Avatar Preview
        function updatePreview() {
            const params = new URLSearchParams(currentOptions);
            const url = `/api/avatar-custom/${currentStyle}?${params.toString()}`;
            
            const img = document.getElementById('avatarPreviewImage');
            img.src = url;
            img.alt = `${currentStyle} Avatar`;
        }

        // Randomize Avatar
        function randomizeAvatar() {
            const style = styleSchemas[currentStyle];
            if (!style) return;

            Object.keys(style.options).forEach(optionKey => {
                const option = style.options[optionKey];
                if (userScore >= option.unlockScore && option.values.length > 0) {
                    const randomIndex = Math.floor(Math.random() * option.values.length);
                    currentOptions[optionKey] = option.values[randomIndex];
                }
            });

            currentOptions.seed = `User-${Date.now()}`;
            renderCustomizationOptions();
            updatePreview();
        }

        // Save Avatar
        function saveAvatar() {
            const avatarData = {
                style: currentStyle,
                options: currentOptions,
                createdAt: new Date().toISOString()
            };

            localStorage.setItem('customAvatar', JSON.stringify(avatarData));
            alert('‚úÖ Avatar gespeichert!');
            
            // Optional: Zur√ºck zur Hauptseite
            // window.location.href = 'index.html';
        }

        // Update Next Unlocks
        function updateNextUnlocks() {
            const style = styleSchemas[currentStyle];
            const nextUnlocksDiv = document.getElementById('nextUnlocks');
            const listDiv = document.getElementById('nextUnlocksList');
            
            const lockedOptions = [];
            Object.keys(style.options).forEach(optionKey => {
                const option = style.options[optionKey];
                if (userScore < option.unlockScore) {
                    lockedOptions.push({
                        name: option.displayName,
                        unlockScore: option.unlockScore
                    });
                }
            });

            // Sortiere nach Unlock-Score
            lockedOptions.sort((a, b) => a.unlockScore - b.unlockScore);

            if (lockedOptions.length > 0) {
                nextUnlocksDiv.style.display = 'block';
                listDiv.innerHTML = '';

                // Zeige die n√§chsten 3 Unlocks
                lockedOptions.slice(0, 3).forEach(unlock => {
                    const item = document.createElement('div');
                    item.className = 'unlock-item';
                    item.innerHTML = `
                        <span class="unlock-item-name">${unlock.name}</span>
                        <span class="unlock-item-points">${unlock.unlockScore}‚òÖ (${unlock.unlockScore - userScore} fehlen)</span>
                    `;
                    listDiv.appendChild(item);
                });
            } else {
                nextUnlocksDiv.style.display = 'none';
            }
        }

        // Starte Initialisierung
        init();
    </script>
</body>
</html>
